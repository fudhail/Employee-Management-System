@{
    ViewBag.Title = "Add Leave";
    var leaveTypeList = ViewBag.LeaveTypes;
    var employeeList = ViewBag.emp;
}

<div class="panel pa">
    <div class="panel-heading text-center">
        <h2 class="panel-title" style="font-weight: 700; font-size: 28px; letter-spacing: 1px;">
            Add Leave Request
        </h2>
    </div>

    <form id="frmLeave" method="POST">

        <div class="form-group">
            <label for="Lid" class="form-label">Leave ID</label>
            <input type="number" class="form-control" id="Lid" name="Lid" value="" readonly>
        </div>
        <!-- Employee Dropdown -->
        <div class="form-group">
            <label for="Eid" class="form-label">Employee</label>
            <select class="form-control" id="Eid" name="Eid" required onchange="updateLeaves()">
                <option value="" disabled selected>Select Employee</option>
                @foreach (var emp in employeeList)
                {
                    <option value="@emp.Eid" data-leaves="@emp.NoOfLeaves">@emp.name</option>
                }
            </select>
        </div>

        <!-- Styled Bootstrap alert box for leaves info -->
        <div id="leavesInfo" class="alert alert-info small" style="display: none; max-width: 280px; ">
            <strong>Remaining Leaves:</strong> <span id="leavesCount"></span>
        </div>
     
        <!-- Leave Type Dropdown -->
        <div class="form-group">
            <label for="Type" class="form-label">Leave Type</label>
            <select class="form-control" id="Type" name="Type" required>
                <option value="" disabled selected>Select Leave Type</option>
                @foreach (var leave in leaveTypeList)
                {
                    <option value="@leave.MID">@leave.MNAME</option>
                }
            </select>
        </div>

        <!-- From Date -->
        <div class="form-group">
            <label for="FromDate" class="form-label">From Date</label>
            <input type="date" class="form-control" id="FromDate" name="FromDate" required>
        </div>

        <!-- To Date -->
        <div class="form-group">
            <label for="ToDate" class="form-label">To Date</label>
            <input type="date" class="form-control" id="ToDate" name="ToDate" required>
        </div>

        <!-- Days (Calculated) -->
        <div class="form-group">
            <label for="Days" class="form-label">Days</label>
            <input type="text" class="form-control" id="Days" name="Days" readonly>
        </div>

        <!-- Reason -->
        <div class="form-group">
            <label for="Reason" class="form-label">Reason</label>
            <textarea class="form-control" id="Reason" name="Reason" rows="3"></textarea>
        </div>

        <button type="button" onclick="saveLeave()" class="btn btn-primary">Submit</button>
    </form>
</div>

<script>
    function calculateDays() {
        const fromDate = new Date(document.getElementById('FromDate').value);
        const toDate = new Date(document.getElementById('ToDate').value);
        const daysField = document.getElementById('Days');

        if (!isNaN(fromDate) && !isNaN(toDate)) {
            const days = Math.max(0, (toDate - fromDate) / (1000 * 60 * 60 * 24) + 1);
            daysField.value = days || '';
        } else {
            daysField.value = '';
        }
    }

    document.getElementById('FromDate').addEventListener('change', calculateDays);
    document.getElementById('ToDate').addEventListener('change', calculateDays);


    function updateLeaves() {
        const select = document.getElementById("Eid");
        const selectedOption = select.options[select.selectedIndex];
        const leaves = selectedOption.getAttribute("data-leaves");
        const infoBox = document.getElementById("leavesInfo");
        const countSpan = document.getElementById("leavesCount");

        if (leaves) {
            countSpan.textContent = leaves;
            infoBox.style.display = "block";
        } else {
            infoBox.style.display = "none";
        }
    }


    function saveLeave() {
        var frm = $('#frmLeave');
        var frmdata = JSON.stringify(frm.serializeArray());


        $.ajax({
            type: "POST",
            url: "/Employee/SaveLeave",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({ sdata: frmdata }),
            success: function (response) {
                if (response === "success") {
                    alert("Leave added successfully.");
                    window.location.href = "/Employee/Leaves";
                } else {
                    alert("Error: " + response);
                }
            },
            error: function (xhr, status, error) {
                console.error("AJAX Error:", error);
                alert("Failed to submit. Check console for details.");
            }
        });
    }
</script>
